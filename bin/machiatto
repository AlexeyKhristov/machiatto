#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var EventEmitter = require('events').EventEmitter;
var Reporter = require('../source/reporters/spec');

var program = require('commander');
var glob = require('glob');

program
  .version(JSON.parse(fs.readFileSync(__dirname + '/../package.json', 'utf8')).version);

program.name = 'machiatto';

program.parse(process.argv);

var runner = new EventEmitter();
var reporter = new Reporter(runner);

function runAssert(assert) {
	assert.run(runner, reporter);
}

glob('./test/*.spec.js', function (err, files) {
	if (err) {
		throw err;
	}

	var suites = files.map(function (file) {
		return require(path.resolve(file));
	});

	var asserts = suites.reduce(function (asserts, suite) {
		var suiteName = suite._name();
		var suiteAsserts = asserts[suiteName] || [];
		asserts[suiteName] = suiteAsserts.concat(suite._asserts());

		return asserts;
	}, {});

	runner.emit('start');

	Object.keys(asserts).forEach(function (suiteName) {
		runner.emit('suite', {title: suiteName});
		asserts[suiteName].forEach(runAssert);
		runner.emit('suite end');
	});

	runner.emit('end');
});